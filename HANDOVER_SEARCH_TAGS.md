# こだわり検索タグ表示機能 実装引継ぎ書

## 概要

`yoruo-navi` テーマのトップページ（front-page.php）にある「こだわり検索」機能において、ユーザーが選択した条件（エリア、職種、給与、働き方、クイックタグ）を検索ボタンの上部にタグとして表示する機能を実装しました。
`yoru-otoko-navi`（Next.js版）のデザインと挙動を参考にしています。

## 変更点

### 1. `front-page.php`

- **タグ表示用コンテナの追加**: 検索フォームの送信ボタン直前に、タグが表示される領域 `#selected-tags-container` を追加しました。
- **テンプレートの修正**: モーダル内で使用される `<template>` タグ（`template-job-type`, `template-salary`, `template-work-style`）内の `input` 要素に `data-label` 属性を追加しました。これにより、JS側で表示用のラベルテキスト（例：「キャバクラ」「時給3000円以上」など）を容易に取得できるようにしています。

### 2. `js/main.js`

- **`updateSelectedTags()` 関数の追加**:
  - フォーム内の選択されたチェックボックス（`tags[]`）および隠しフィールド（`hidden input`）をスキャンし、タグを生成・表示する関数です。
  - タグには「×」ボタンが含まれており、クリックすると該当する入力値を削除/選択解除します。
- **モーダル同期ロジックの更新**:
  - モーダル内の操作でメインフォームに `hidden input` を生成する際、`data-label` 属性もコピーするように変更しました。
  - 変更時に `updateSelectedTags()` を呼び出し、表示を即時更新するようにしました。
- **地図検索モーダルの挙動変更**:
  - 「この条件で検索する」ボタン（`#commit-munis`）のクリック時の挙動を、**フォーム送信（submit）からタグ表示の更新へ**変更しました。これにより、ユーザーは検索前に選択内容を確認できます。
- **初期化処理**: ページ読み込み時およびフォーム変更時にタグ表示を更新するイベントリスナーを追加しました。
- **モーダルの状態復元（追加）**: 市区町村選択モーダルを再度開いた際、メインフォーム上の `muni[]` 入力値を読み取り、選択状態を復元（ハイドレーション）するようにしました。これにより、ユーザーは一度閉じたモーダルを再度開いても選択内容を維持できます。
- **クリーンアップ**: 実装時のTODOコメントや不要な「Note to self」コメントを整理・削除しました。

### 3. `archive-job.php` (追加)

- **市区町村検索ロジックの実装**: URLから `muni[]` パラメーターを取得し、メタデータ `area` に対して `LIKE` 検索を行うように `WP_Query` を調整しました（`query_posts` を使用）。
- **都道府県・市区町村の共通フィルター**: `pref` と `muni[]` の両方が存在する場合、それらの条件を反映して求人結果を表示するようにしました。

### 4. `js/japan-map.js`

- **北海道のクリック判定の修正**: 北海道は「地方ID」と「都道府県ID」が同じ「hokkaido」であるため、従来の判定ロジックでは除外されてしまいクリックが反応しない不具合がありました。これを例外的に許可するように修正しました。

## 動作の仕組み

1.  ユーザーが「こだわり検索」やモーダルで条件を選択します。
2.  `main.js` が検知し、メインフォーム（`#main-search-form`）に `hidden input` を追加、またはチェックボックスの状態を変更します。
3.  `updateSelectedTags()` が呼び出され、フォーム内の有効な条件を収集します。
4.  収集した条件（`input.value` または `input.dataset.label`）を元に、Next.js版と同様のデザイン（Tailwind CSS）でタグをレンダリングします。
5.  「この条件で検索する」ボタンを押すと、すべての条件を含んだ状態でフォームが送信されます。

## 今後の確認・修正事項

- **動作確認**: ブラウザで実際に条件を選択し、タグが正しく表示・削除できるか確認してください。特に地図検索（都道府県・市区町村）の連携と、検索結果ページでの絞り込みが意図通りか確認が必要です。
- **パフォーマンス**: `query_posts` を使用してクエリを再実行しているため、大規模なサイトでは `pre_get_posts` フックへの移行を推奨します。現状の yoruo-navi の規模では問題ありません。
- **デザイン調整**: タグのスタイルは `yoru-otoko-navi` を参考にしていますが、微調整が必要な場合は `updateSelectedTags` 内の `addTag` 関数にあるクラス名を修正してください。
